{"version":3,"file":"backup-3ac5f350-eba276d.js","sources":["../node_modules/.pnpm/@vicons+ionicons5@0.11.0/node_modules/@vicons/ionicons5/es/TrashSharp.js","../node_modules/.pnpm/@vicons+material@0.11.0/node_modules/@vicons/material/es/UndoRound.js","../node_modules/.pnpm/@vicons+material@0.11.0/node_modules/@vicons/material/es/RedoRound.js","../src/views/other/backup.tsx"],"sourcesContent":["import { createVNode as _createVNode, openBlock as _openBlock, createBlock as _createBlock, defineComponent } from 'vue'\nconst _hoisted_1 = {\n  xmlns: 'http://www.w3.org/2000/svg',\n  'xmlns:xlink': 'http://www.w3.org/1999/xlink',\n  viewBox: '0 0 512 512'\n}\nconst _hoisted_2 = /*#__PURE__*/ _createVNode(\n  'path',\n  {\n    d: 'M296 64h-80a7.91 7.91 0 0 0-8 8v24h96V72a7.91 7.91 0 0 0-8-8z',\n    fill: 'none'\n  },\n  null,\n  -1\n  /* HOISTED */\n)\nconst _hoisted_3 = /*#__PURE__*/ _createVNode(\n  'path',\n  {\n    d: 'M292 64h-72a4 4 0 0 0-4 4v28h80V68a4 4 0 0 0-4-4z',\n    fill: 'none'\n  },\n  null,\n  -1\n  /* HOISTED */\n)\nconst _hoisted_4 = /*#__PURE__*/ _createVNode(\n  'path',\n  {\n    d: 'M447.55 96H336V48a16 16 0 0 0-16-16H192a16 16 0 0 0-16 16v48H64.45L64 136h33l20.09 314A32 32 0 0 0 149 480h214a32 32 0 0 0 31.93-29.95L415 136h33zM176 416l-9-256h33l9 256zm96 0h-32V160h32zm24-320h-80V68a4 4 0 0 1 4-4h72a4 4 0 0 1 4 4zm40 320h-33l9-256h33z',\n    fill: 'currentColor'\n  },\n  null,\n  -1\n  /* HOISTED */\n)\nexport default defineComponent({\n  name: 'TrashSharp',\n  render: function render(_ctx, _cache) {\n    return _openBlock(), _createBlock('svg', _hoisted_1, [_hoisted_2, _hoisted_3, _hoisted_4])\n  }\n})\n","import { createVNode as _createVNode, openBlock as _openBlock, createBlock as _createBlock, defineComponent } from 'vue'\nconst _hoisted_1 = {\n  xmlns: 'http://www.w3.org/2000/svg',\n  'xmlns:xlink': 'http://www.w3.org/1999/xlink',\n  viewBox: '0 0 24 24'\n}\nconst _hoisted_2 = /*#__PURE__*/ _createVNode(\n  'path',\n  {\n    d: 'M12.5 8c-2.65 0-5.05.99-6.9 2.6L3.71 8.71C3.08 8.08 2 8.52 2 9.41V15c0 .55.45 1 1 1h5.59c.89 0 1.34-1.08.71-1.71l-1.91-1.91c1.39-1.16 3.16-1.88 5.12-1.88c3.16 0 5.89 1.84 7.19 4.5c.27.56.91.84 1.5.64c.71-.23 1.07-1.04.75-1.72C20.23 10.42 16.65 8 12.5 8z',\n    fill: 'currentColor'\n  },\n  null,\n  -1\n  /* HOISTED */\n)\nexport default defineComponent({\n  name: 'UndoRound',\n  render: function render(_ctx, _cache) {\n    return _openBlock(), _createBlock('svg', _hoisted_1, [_hoisted_2])\n  }\n})\n","import { createVNode as _createVNode, openBlock as _openBlock, createBlock as _createBlock, defineComponent } from 'vue'\nconst _hoisted_1 = {\n  xmlns: 'http://www.w3.org/2000/svg',\n  'xmlns:xlink': 'http://www.w3.org/1999/xlink',\n  viewBox: '0 0 24 24'\n}\nconst _hoisted_2 = /*#__PURE__*/ _createVNode(\n  'path',\n  {\n    d: 'M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.16 0-7.74 2.42-9.44 5.93c-.32.67.04 1.47.75 1.71c.59.2 1.23-.08 1.5-.64c1.3-2.66 4.03-4.5 7.19-4.5c1.95 0 3.73.72 5.12 1.88l-1.91 1.91c-.63.63-.19 1.71.7 1.71H21c.55 0 1-.45 1-1V9.41c0-.89-1.08-1.34-1.71-.71l-1.89 1.9z',\n    fill: 'currentColor'\n  },\n  null,\n  -1\n  /* HOISTED */\n)\nexport default defineComponent({\n  name: 'RedoRound',\n  render: function render(_ctx, _cache) {\n    return _openBlock(), _createBlock('svg', _hoisted_1, [_hoisted_2])\n  }\n})\n","import TrashSharp from '@vicons/ionicons5/es/TrashSharp'\nimport UndoRound from '@vicons/material/es/UndoRound'\nimport RedoRound from '@vicons/material/es/RedoRound'\n\nimport { HeaderActionButton } from 'components/button/rounded-button'\nimport { Table } from 'components/table'\nimport { useTable } from 'hooks/use-table'\nimport { ContentLayout } from 'layouts/content'\nimport { NButton, NPopconfirm, NSpace, useDialog } from 'naive-ui'\nimport { socket } from 'socket'\nimport { responseBlobToFile, RESTManager } from 'utils'\nimport { defineComponent, onBeforeMount } from 'vue'\n\nexport default defineComponent(() => {\n  const { checkedRowKeys, data, fetchDataFn } = useTable<{\n    filename: string\n    size: string\n  }>((data) => async () => {\n    const response = (await RESTManager.api.backups.get()) as any\n    // sort by filename\n    const data$ = response.data as { filename: string; size: string }[]\n    data$.sort((b, a) => a.filename.localeCompare(b.filename))\n\n    data.value = data$ as any\n  })\n  onBeforeMount(() => {\n    fetchDataFn()\n  })\n  const dialog = useDialog()\n  const handleBackup = async () => {\n    const info = message.info('备份中', { duration: 10e8, closable: true })\n\n    const blob = await RESTManager.api.backups.new.get({\n      responseType: 'blob',\n      timeout: 10e8,\n    })\n    info.destroy()\n    message.success('备份完成')\n    responseBlobToFile(blob, 'backup.zip')\n  }\n  const handleUploadAndRestore = async () => {\n    const $file = document.createElement('input')\n    $file.type = 'file'\n    $file.style.cssText = `position: absolute; opacity: 0; z-index: -9999;top: 0; left: 0`\n    $file.accept = '.zip'\n    document.body.append($file)\n    $file.click()\n    $file.onchange = () => {\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const file = $file.files![0]\n      const formData = new FormData()\n      formData.append('file', file)\n      RESTManager.api.backups\n        .post({\n          data: formData,\n          timeout: Infinity,\n          headers: {\n            'Content-Type': 'multipart/form-data',\n          },\n        })\n        .then(() => {\n          message.success('恢复成功, 页面将会重载')\n          setTimeout(() => {\n            location.reload()\n          }, 1000)\n        })\n    }\n  }\n  const handleDelete = async (filename: string | string[]) => {\n    let files = ''\n    if (Array.isArray(filename)) {\n      files = filename.join(',')\n    } else {\n      files = filename\n    }\n    await RESTManager.api.backups.delete({\n      params: {\n        files,\n      },\n    })\n\n    message.success('删除成功')\n    if (Array.isArray(filename)) {\n      filename.forEach((filename) => {\n        const index = data.value.findIndex((i) => i.filename === filename)\n        if (index != -1) {\n          data.value.splice(index, 1)\n        }\n      })\n    } else {\n      const index = data.value.findIndex((i) => i.filename === filename)\n      if (index != -1) {\n        data.value.splice(index, 1)\n      }\n    }\n  }\n  const handleRollback = async (filename: string) => {\n    await RESTManager.api.backups(filename).patch({\n      // TODO socket id\n      params: { sid: socket.socket.id },\n    })\n  }\n  const handleDownload = async (filename: string) => {\n    const info = message.info('下载中', { duration: 10e8, closable: true })\n    const blob = await RESTManager.api.backups(filename).get({\n      responseType: 'blob',\n      timeout: 10e8,\n      getResponse: true,\n    })\n    info.destroy()\n    message.success('下载完成')\n\n    responseBlobToFile(blob, filename + '.zip')\n  }\n\n  return () => (\n    <ContentLayout\n      actionsElement={\n        <>\n          <HeaderActionButton\n            icon={<UndoRound />}\n            name=\"立即备份\"\n            variant=\"primary\"\n            onClick={handleBackup}\n          ></HeaderActionButton>\n          <HeaderActionButton\n            icon={<RedoRound />}\n            onClick={handleUploadAndRestore}\n            name=\"上传恢复\"\n            variant=\"info\"\n          ></HeaderActionButton>\n          <HeaderActionButton\n            icon={<TrashSharp />}\n            name=\"批量删除\"\n            variant=\"error\"\n            disabled={!checkedRowKeys.value.length}\n            onClick={() => {\n              dialog.warning({\n                title: '警告',\n                content: '你确定要删除多个备份？',\n                positiveText: '达咩',\n                negativeText: '确定',\n                onNegativeClick: async () => {\n                  handleDelete(checkedRowKeys.value)\n                },\n              })\n            }}\n          ></HeaderActionButton>\n        </>\n      }\n    >\n      <Table\n        {...{ data, fetchDataFn }}\n        checkedRowKey=\"filename\"\n        nTableProps={{\n          maxHeight: 'calc(100vh - 17rem)',\n          virtualScroll: true,\n        }}\n        onUpdateCheckedRowKeys={(keys) => {\n          checkedRowKeys.value = keys\n        }}\n        maxWidth={500}\n        columns={[\n          {\n            type: 'selection',\n            options: ['none', 'all'],\n          },\n\n          { title: '日期', key: 'filename' },\n          { title: '大小', key: 'size', width: 200 },\n          {\n            title: '操作',\n            fixed: 'right',\n            key: 'filename',\n            render(row) {\n              const filename = row.filename\n              return (\n                <NSpace inline>\n                  <NButton\n                    text\n                    size=\"tiny\"\n                    type=\"primary\"\n                    onClick={() => void handleDownload(filename)}\n                  >\n                    下载\n                  </NButton>\n\n                  <NButton\n                    text\n                    size=\"tiny\"\n                    type=\"warning\"\n                    onClick={() => void handleRollback(filename)}\n                  >\n                    回退\n                  </NButton>\n\n                  <NPopconfirm\n                    positiveText={'取消'}\n                    negativeText=\"删除\"\n                    onNegativeClick={() => {\n                      handleDelete(filename)\n                    }}\n                  >\n                    {{\n                      trigger: () => (\n                        <NButton text size=\"tiny\" type=\"error\">\n                          移除\n                        </NButton>\n                      ),\n\n                      default: () => (\n                        <span style={{ maxWidth: '12rem' }}>确定要删除?</span>\n                      ),\n                    }}\n                  </NPopconfirm>\n                </NSpace>\n              )\n            },\n          },\n        ]}\n        noPagination\n      ></Table>\n    </ContentLayout>\n  )\n})\n"],"names":["_hoisted_1","xmlns","viewBox","_hoisted_2","d","fill","_hoisted_3","_hoisted_4","defineComponent","name","render","_ctx","_cache","_openBlock","_createBlock","checkedRowKeys","data","fetchDataFn","useTable","data2","async","data$","RESTManager","api","backups","get","sort","b","a","filename","localeCompare","value","dialog","useDialog","handleBackup","info","message","duration","closable","blob","new","responseType","timeout","destroy","success","handleUploadAndRestore","$file","document","createElement","type","style","cssText","accept","body","append","click","onchange","file","files","formData","FormData","post","Infinity","headers","then","reload","handleDelete","Array","isArray","join","delete","params","forEach","filename2","index","findIndex","i","splice","ContentLayout","actionsElement","HeaderActionButton","icon","UndoRound","variant","onClick","RedoRound","TrashSharp","disabled","length","warning","title","content","positiveText","negativeText","onNegativeClick","Table","checkedRowKey","nTableProps","maxHeight","virtualScroll","onUpdateCheckedRowKeys","keys","maxWidth","columns","options","key","width","fixed","row","NSpace","inline","NButton","text","size","getResponse","handleDownload","patch","sid","socket","id","handleRollback","NPopconfirm","trigger","default","noPagination"],"mappings":"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"}